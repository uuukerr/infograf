<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конструктор инфографики</title>
    <link rel="stylesheet" href="styles.css">

    <!-- Основные библиотеки -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs/dist/pptxgen.bundle.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@d3fc/d3fc-cartogram/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <!-- Ресурсы draw.io -->
    <link rel="stylesheet" href="https://www.draw.io/js/mxClient.css" />
    <script src="https://www.draw.io/js/mxClient.js"></script>

    <style>
        .tooltip {
            position: absolute;
            z-index: 10;
            visibility: hidden;
            background-color: white;
            border-radius: 5px;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            padding: 5px;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <script>
        // Функциональность автоматического генератора остается неизменной
        async function exportPresentation() {
            const pres = new PptxGenJS();
            const slide = pres.addSlide(); // Новый чистый слайд
            const element = document.querySelector("#visualization-output");
            const canvas = await html2canvas(element, { allowTaint: true, useCORS: true });
            const pngBlob = await new Promise((resolve) => canvas.toBlob(resolve));
            const buffer = await pngBlob.arrayBuffer();
            const base64Str = btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)));
            const imgSrc = `data:image/png;base64,${base64Str}`;
            slide.addImage({
                data: imgSrc,
                fit: true,
                x: 0, y: 0,
                cx: 720, cy: 540
            });
            pres.writeFile({ filename: "Инфографика.pptx" });
        }

        function exportSvg() {
            const svgElement = document.querySelector("#visualization-output svg");
            const serializer = new XMLSerializer();
            const svgXml = serializer.serializeToString(svgElement);
            const blob = new Blob([svgXml], { type: "image/svg+xml" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "my-svg.svg";
            link.click();
            URL.revokeObjectURL(url);
        }

        async function exportImage() {
            const element = document.querySelector("#visualization-output");
            const canvas = await html2canvas(element);
            const pngBlob = await new Promise((resolve) => canvas.toBlob(resolve));
            const link = document.createElement("a");
            link.href = URL.createObjectURL(pngBlob);
            link.download = "test-image.png";
            link.click();
        }

        function exportExcel() {
            const wb = XLSX.utils.book_new();
            const ws_data = currentData.map(d => ({ Year: d.year, GDP: d.gdp }));
            const ws = XLSX.utils.json_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Данные");
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
            const blob = new Blob([s2ab(wbout)], { type: "application/octet-stream" });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = downloadUrl;
            a.download = "данные.xlsx";
            a.click();
            URL.revokeObjectURL(downloadUrl);
        }

        function s2ab(s) {
            var buf = new ArrayBuffer(s.length);
            var view = new Uint8Array(buf);
            for (var i = 0; i != s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
            return buf;
        }

        function updateFontSize(size) {
            d3.selectAll("text").style("font-size", size + "px");
        }

        function updateLineThickness(thickness) {
            d3.selectAll(".line").style("stroke-width", thickness + "px");
        }

        function updateBackgroundColor(color) {
            d3.select("svg").style("background-color", color);
        }

        function updatePrimaryColor(color) {
            d3.selectAll(".line").style("stroke", color);
            d3.selectAll(".point").style("fill", color);
        }

        function drawPieChart(outputContainer, title) {
            // Реализация построения круговой диаграммы
        }

        function drawHeatmap(outputContainer, title, data) {
            // Реализация построения тепловой карты
        }

        function drawTreemap(outputContainer, title, data) {
            // Реализация построения дерева
        }

        function drawForceDirectedGraph(outputContainer, title, data) {
            // Реализация построения сети
        }

        function drawRadarChart(outputContainer, title, data) {
            // Реализация построения радара
        }

        function drawAreaChart(outputContainer, title, xlabel, ylabel, data) {
            // Реализация построения графика с областями
        }

        function drawParallelCoordinates(outputContainer, title, data) {
            // Реализация параллельных координат
        }

        function drawStreamgraph(outputContainer, title, data) {
            // Реализация скользящего графика
        }

        function drawChoroplethMap(outputContainer, title, data) {
            // Реализация картограммы
        }

        function drawWaterfallChart(outputContainer, title, data) {
            // Реализация водопадного графика
        }

        function drawBubbleChart(outputContainer, title, data) {
            // Реализация графика с пузырьками
        }

        function drawCartogram(outputContainer, title, data) {
            // Реализация картограммы
        }

        function drawLineChart(outputContainer, title, xlabel, ylabel, data) {
            // Реализация линейного графика
        }

        // Вспомогательные функции
        function exportDiagram() {
            const diagramContainer = document.getElementById('diagram-container');
            const xmlData = mxUtils.getGraph(diagramContainer).model.toXml();
            const imgData = mxUtils.getExportImage(xmlData, 'png');
            const a = document.createElement('a');
            a.href = imgData;
            a.download = 'diagram.png';
            a.click();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Основная логика приложения
        let currentData = []; // Хранение данных
        let activeChartType = ""; // Тип активного графика

        document.getElementById('generate-button').addEventListener('click', () => {
            const textarea = document.querySelector('#data-textarea');
            const csvData = textarea.value.trim();
            const parsedData = d3.csvParse(csvData);
            processData(parsedData); // обработать и подготовить данные
        });

        document.getElementById('file-upload').addEventListener('change', handleFileUpload);

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.readAsText(file);
            reader.onload = () => {
                const uploadedData = d3.csvParse(reader.result);
                processData(uploadedData); // обработать загруженные данные
            };
        }

        function processData(data) {
            currentData = data;
            updateVisualization(); // обновить визуализацию
        }

        function updateVisualization() {
            const chartType = document.querySelector('#chart-type').value;
            const title = document.querySelector('#title').value || 'Инфографика';
            const xlabel = document.querySelector('#xlabel').value || 'Год';
            const ylabel = document.querySelector('#ylabel').value || 'Значение';

            const outputContainer = document.querySelector('#visualization-output');
            outputContainer.innerHTML = '';

            if (!currentData || !Array.isArray(currentData)) {
                alert('Нет данных для визуализации!');
                return;
            }

            switch (chartType) {
                case 'line':
                    drawLineChart(outputContainer, title, xlabel, ylabel, currentData);
                    break;
                case 'pie':
                    drawPieChart(outputContainer, title, currentData);
                    break;
                case 'heatmap':
                    drawHeatmap(outputContainer, title, currentData);
                    break;
                case 'treemap':
                    drawTreemap(outputContainer, title, currentData);
                    break;
                case 'force-directed':
                    drawForceDirectedGraph(outputContainer, title, currentData);
                    break;
                case 'radar':
                    drawRadarChart(outputContainer, title, currentData);
                    break;
                case 'area':
                    drawAreaChart(outputContainer, title, xlabel, ylabel, currentData);
                    break;
                case 'parallel-coordinates':
                    drawParallelCoordinates(outputContainer, title, currentData);
                    break;
                case 'streamgraph':
                    drawStreamgraph(outputContainer, title, currentData);
                    break;
                case 'choropleth-map':
                    drawChoroplethMap(outputContainer, title, currentData);
                    break;
                case 'waterfall':
                    drawWaterfallChart(outputContainer, title, currentData);
                    break;
                case 'bubble':
                    drawBubbleChart(outputContainer, title, currentData);
                    break;
                case 'cartogram':
                    drawCartogram(outputContainer, title, currentData);
                    break;
                default:
                    console.error("Неизвестный тип графика:", chartType);
            }
        }
    </script>

    <header class="header">
        <h1>Конструктор инфографики</h1>
    </header>

    <nav class="mode-navigation">
        <button id="automatic-mode-btn">Автоматическая инфографика</button>
        <button id="free-design-btn">Свободное построение</button>
    </nav>

    <main class="main">
        <section class="constructor-section">
            <div class="constructor-title">
                <h2>Ввод данных и настройка</h2>
            </div>
            <form id="upload-form">
                <textarea rows="5" cols="50" id="data-textarea" placeholder="Ваши данные в формате CSV..."></textarea>
                <input type="file" accept=".csv,.xls,.json" id="file-upload" />
                <button type="button" id="generate-button">Создать инфографику</button>
            </form>
        </section>

        <section class="output-section">
            <div class="output-title">
                <h2>Результат визуализации</h2>
            </div>
            <div id="visualization-output"></div>
        </section>

        <section class="manual-diagramming">
            <h2>Свободное создание диаграмм</h2>

            <!-- Новая панель инструментов -->
            <div id="stencils-panel" style="float: left; width: 20%; height: 600px; overflow: auto;"></div>

            <!-- Рабочая область -->
            <div id="diagram-container" style="float: left; width: 80%; height: 600px; border: 1px solid #ddd;"></div>
        </section>
    </main>

    <footer class="footer">
        <p>© 2025 Конструктор инфографики. Все права защищены.</p>
    </footer>

    <script>
        // Инициализация редактора draw.io при загрузке страницы
        document.addEventListener('DOMContentLoaded', function () {
            const editorOptions = {
                container: document.getElementById('diagram-container'),
                editMode: true,                      // Активация режима редактирования
                theme: 'light',                      // Тема интерфейса
                ui: 'sketch',                        // Интерфейс Sketch
                format: 'png',                       // Формат экспорта
                autosave: true,                      // Автосохранение
                toolbarsVisible: true,               // Панели инструментов видны
                menuBarVisible: true,                // Верхняя панель меню видима
                libraries: ['flowchart'],            // Доступные библиотеки элементов
                shapes: ['basic', 'flowchart'],      // Доступные группы фигур
                stencilConfig: {                     // Управляем панелью стикеров
                    showStencilSearch: true,         // Включаем поиск по фигурам
                    categories: ['all']              // Категория элементов
                }
            };

            // Создаём верхнюю панель меню
            const menuBar = document.createElement('div');
            menuBar.id = 'menu-bar';
            menuBar.style.position = 'fixed';
            menuBar.style.top = '0';
            menuBar.style.left = '0';
            menuBar.style.zIndex = '1000';
            menuBar.style.backgroundColor = '#fff';
            menuBar.style.borderBottom = '1px solid #ccc';
            menuBar.style.width = '100%';
            menuBar.style.height = '30px';
            menuBar.style.lineHeight = '30px';
            menuBar.style.fontFamily = 'Arial, sans-serif';
            menuBar.style.color = '#333';
            menuBar.style.padding = '0 10px';
            menuBar.textContent = 'Меню инструментов';

            // Создаём панели инструментов
            const stencilPanel = document.getElementById('stencils-panel');
            stencilPanel.style.float = 'left';
            stencilPanel.style.width = '20%';
            stencilPanel.style.height = '600px';
            stencilPanel.style.overflow = 'auto';

            // Добавляем верхнее меню и панели инструментов
            document.body.prepend(menuBar);

            // Инициализируем редактор
            mxEditor.init(editorOptions);
        });

        // Переключение между режимами
        document.getElementById('automatic-mode-btn').addEventListener('click', function () {
            document.querySelector('.output-section').style.display = 'block';
            document.querySelector('.manual-diagramming').style.display = 'none';
        });

        document.getElementById('free-design-btn').addEventListener('click', function () {
            document.querySelector('.output-section').style.display = 'none';
            document.querySelector('.manual-diagramming').style.display = 'block';
        });

        // Экспорт диаграммы
        function exportDiagram() {
            const diagramContainer = document.getElementById('diagram-container');
            const xmlData = mxUtils.getGraph(diagramContainer).model.toXml();
            const imgData = mxUtils.getExportImage(xmlData, 'png');
            const a = document.createElement('a');
            a.href = imgData;
            a.download = 'diagram.png';
            a.click();
        }
    </script>
</body>

</html>
